<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="KindWords.Views.MyMessagesPage"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:models="clr-namespace:KindWords.Models"
             xmlns:viewmodels="clr-namespace:KindWords.ViewModels"
             x:DataType="viewmodels:MyMessagesViewModel"
             Title="My Messages"
             BackgroundColor="#F5F5DC">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackLayout Grid.Row="0" Padding="20,20,20,10" BackgroundColor="#F8F9FA">
            <Label Text="My Messages" 
                   FontSize="24" 
                   FontFamily="OpenSansSemibold"
                   HorizontalOptions="Center" 
                   TextColor="#2F4F4F" />
            
            <Label Text="Your affirmations and all replies received" 
                   FontSize="14" 
                   HorizontalOptions="Center" 
                   TextColor="#708090" />
        </StackLayout>

        <!-- Loading Indicator -->
        <ActivityIndicator Grid.Row="1"
                          IsVisible="{Binding IsLoading}"
                          IsRunning="{Binding IsLoading}"
                          Color="#FF6B9D"
                          VerticalOptions="Center"
                          HorizontalOptions="Center" />

        <!-- No Messages State -->
        <StackLayout Grid.Row="1" 
                     IsVisible="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}"
                     VerticalOptions="CenterAndExpand"
                     Padding="40">
            <StackLayout.Triggers>
                <DataTrigger TargetType="StackLayout" Binding="{Binding HasMessages}" Value="True">
                    <Setter Property="IsVisible" Value="False" />
                </DataTrigger>
            </StackLayout.Triggers>
            
            <Label Text="📝" 
                   FontSize="48" 
                   HorizontalOptions="Center" 
                   TextColor="#E0E0E0" />
            
            <Label Text="No messages yet" 
                   FontSize="18" 
                   FontFamily="OpenSansSemibold"
                   HorizontalOptions="Center" 
                   TextColor="#708090" 
                   Margin="0,10,0,5" />
            
            <Label Text="Send your first affirmation from the Send tab!" 
                   FontSize="14" 
                   HorizontalOptions="Center" 
                   TextColor="#A0A0A0" 
                   HorizontalTextAlignment="Center" />
        </StackLayout>

        <!-- Messages List -->
        <RefreshView Grid.Row="1" 
                     IsRefreshing="{Binding IsLoading}" 
                     Command="{Binding RefreshCommand}"
                     RefreshColor="#FF6B9D">
            <RefreshView.Triggers>
                <DataTrigger TargetType="RefreshView" Binding="{Binding HasMessages}" Value="False">
                    <Setter Property="IsVisible" Value="False" />
                </DataTrigger>
            </RefreshView.Triggers>
            
            <CollectionView ItemsSource="{Binding MyMessages}" 
                            BackgroundColor="Transparent">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="{x:Type models:Message}">
                        <Grid Padding="20,0">
                            <Frame BackgroundColor="White"
                                   CornerRadius="12"
                                   HasShadow="True"
                                   Padding="16">
                                <StackLayout Spacing="12">
                                    
                                    <!-- Message Header -->
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>
                                        
                                        <!-- Category Badge -->
                                        <Frame Grid.Column="0"
                                               BackgroundColor="{Binding CategoryColor}"
                                               CornerRadius="12"
                                               Padding="8,4"
                                               HasShadow="False">
                                            <Label Text="{Binding CategoryEmoji}" 
                                                   FontSize="12"
                                                   TextColor="White" />
                                        </Frame>
                                        
                                        <!-- Category Name -->
                                        <Label Grid.Column="1"
                                               Text="{Binding Category}"
                                               FontFamily="OpenSansSemibold"
                                               FontSize="14"
                                               TextColor="{Binding CategoryColor}"
                                               VerticalOptions="Center"
                                               Margin="8,0,0,0" />
                                        
                                        <!-- Reply Count -->
                                        <Label Grid.Column="2"
                                               Text="{Binding ReplyCount, StringFormat='{0} replies'}"
                                               FontSize="12"
                                               TextColor="#708090"
                                               VerticalOptions="Center" />
                                    </Grid>

                                    <!-- Message Content -->
                                    <Label Text="{Binding Content}"
                                           FontSize="16"
                                           TextColor="#2F4F4F"
                                           LineBreakMode="WordWrap" />

                                    <!-- Timestamp -->
                                    <Label Text="{Binding CreatedAt, StringFormat='Sent on {0:MMM dd, yyyy at h:mm tt}'}"
                                           FontSize="12"
                                           TextColor="#A0A0A0" />

                                    <!-- Replies Section -->
                                    <StackLayout IsVisible="{Binding AllReplies.Count, Converter={StaticResource IsNotNullConverter}}"
                                                 Spacing="8"
                                                 Margin="0,8,0,0">
                                        <BoxView HeightRequest="1" 
                                                 BackgroundColor="#E0E0E0" 
                                                 HorizontalOptions="FillAndExpand" />
                                        
                                        <Label Text="💬 Replies Received:"
                                               FontFamily="OpenSansSemibold"
                                               FontSize="14"
                                               TextColor="#4682B4" />
                                        
                                        <CollectionView ItemsSource="{Binding AllReplies}">
                                            <CollectionView.ItemTemplate>
                                                <DataTemplate x:DataType="{x:Type models:Reply}">
                                                    <Frame BackgroundColor="{Binding ReplyColor}"
                                                           BorderColor="{Binding BorderColor}"
                                                           CornerRadius="8"
                                                           Padding="12"
                                                           HasShadow="False"
                                                           Margin="16,0,0,0">
                                                        <StackLayout Spacing="8">
                                                            <Label Text="{Binding Content}"
                                                                   FontSize="14"
                                                                   TextColor="#2F4F4F"
                                                                   LineBreakMode="WordWrap" />
                                                            
                                                            <Grid>
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="*" />
                                                                    <ColumnDefinition Width="Auto" />
                                                                </Grid.ColumnDefinitions>
                                                                
                                                                <Label Grid.Column="0"
                                                                       Text="{Binding TimeAgo}"
                                                                       FontSize="11"
                                                                       TextColor="#8B7355"
                                                                       VerticalOptions="Center" />
                                                                
                                                                <!-- Like Button and Count -->
                                                                <StackLayout Grid.Column="1" 
                                                                             Orientation="Horizontal" 
                                                                             Spacing="4">
                                                                    <Button Text="{Binding IsLikedByMessageOwner, Converter={StaticResource BoolToHeartConverter}}"
                                                                            BackgroundColor="Transparent"
                                                                            TextColor="{Binding IsLikedByMessageOwner, Converter={StaticResource BoolToLikeColorConverter}}"
                                                                            FontSize="18"
                                                                            Padding="4"
                                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MyMessagesViewModel}}, Path=ToggleLikeReplyCommand}"
                                                                            CommandParameter="{Binding .}" />
                                                                    
                                                                    <Label Text="{Binding LikeCount}"
                                                                           FontSize="11"
                                                                           TextColor="#8B7355"
                                                                           VerticalOptions="Center"
                                                                           IsVisible="{Binding LikeCount, Converter={StaticResource IsNotZeroConverter}}" />
                                                                </StackLayout>
                                                            </Grid>
                                                        </StackLayout>
                                                    </Frame>
                                                </DataTemplate>
                                            </CollectionView.ItemTemplate>
                                        </CollectionView>
                                    </StackLayout>

                                </StackLayout>
                            </Frame>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>
    </Grid>

</ContentPage> 