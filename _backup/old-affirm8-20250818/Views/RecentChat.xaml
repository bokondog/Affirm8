<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="Affirm8.Views.Chat.RecentChat"
             xmlns:local="clr-namespace:Affirm8"
             xmlns:controls="clr-namespace:Affirm8.Controls"
             xmlns:converter="clr-namespace:Affirm8.Converters"
             x:DataType="local:RecentChatViewModel" 
             Title="Messages">

    <ContentPage.BindingContext>
        <local:RecentChatViewModel/>
    </ContentPage.BindingContext>

    <ContentPage.Resources>
        <ResourceDictionary>
            <converter:StringToBadgeIconConverter x:Key="StringToBadgeIconConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <ContentPage.Content>
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!-- Header with buttons -->
            <Grid Grid.Row="0" Padding="16,8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <Label Grid.Column="0"
                       Text="Messages"
                       FontSize="24"
                       FontFamily="Roboto-Medium"
                       TextColor="{AppThemeBinding Light={DynamicResource PrimaryTextColorLight}, Dark={DynamicResource PrimaryTextColorDark}}"
                       VerticalOptions="Center" />

                <Button Grid.Column="1"
                        Text="ðŸ”"
                        BackgroundColor="Transparent"
                        TextColor="{AppThemeBinding Light={DynamicResource PrimaryTextColorLight}, Dark={DynamicResource PrimaryTextColorDark}}"
                        FontSize="20"
                        WidthRequest="40"
                        HeightRequest="40"
                        Command="{Binding SearchCommand}" />

                <Button Grid.Column="2"
                        Text="âœï¸"
                        BackgroundColor="Transparent"
                        TextColor="{AppThemeBinding Light={DynamicResource PrimaryTextColorLight}, Dark={DynamicResource PrimaryTextColorDark}}"
                        FontSize="20"
                        WidthRequest="40"
                        HeightRequest="40"
                        Command="{Binding NewMessageCommand}" />
            </Grid>

            <!-- Search Bar -->
            <SearchBar Grid.Row="1"
                      Placeholder="Search messages..."
                      Text="{Binding SearchText}"
                      Margin="16,0" />

            <!-- Messages List -->
            <CollectionView Grid.Row="2"
                           ItemsSource="{Binding RecentChatMessages}"
                           SelectionMode="Single"
                           SelectedItem="{Binding SelectedMessage}"
                           SelectionChangedCommand="{Binding MessageSelectionChangedCommand}"
                           BackgroundColor="Transparent"
                           Margin="8,8,8,0">

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="local:ChatMessage">
                        <SwipeView>
                            <!-- Swipe Actions -->
                            <SwipeView.RightItems>
                                <SwipeItems>
                                    <SwipeItem Text="Archive"
                                              BackgroundColor="Orange"
                                              Command="{Binding Source={RelativeSource AncestorType={x:Type local:RecentChatViewModel}}, Path=ArchiveCommand}"
                                              CommandParameter="{Binding .}" />
                                    <SwipeItem Text="Delete"
                                              BackgroundColor="Red"
                                              Command="{Binding Source={RelativeSource AncestorType={x:Type local:RecentChatViewModel}}, Path=DeleteCommand}"
                                              CommandParameter="{Binding .}" />
                                    <SwipeItem Text="More"
                                              BackgroundColor="Gray"
                                              Command="{Binding Source={RelativeSource AncestorType={x:Type local:RecentChatViewModel}}, Path=MoreCommand}"
                                              CommandParameter="{Binding .}" />
                                </SwipeItems>
                            </SwipeView.RightItems>

                            <!-- Main Content -->
                            <Border Margin="8,4"
                                   Padding="12"
                                   BackgroundColor="{AppThemeBinding Light={DynamicResource CardBackgroundLight}, Dark={DynamicResource CardBackgroundDark}}"
                                   Stroke="{AppThemeBinding Light={DynamicResource BorderColorLight}, Dark={DynamicResource BorderColorDark}}"
                                   StrokeThickness="0.5">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="8" />
                                </Border.StrokeShape>

                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <!-- Avatar with Badge -->
                                    <controls:BadgeView Grid.Column="0"
                                                       ShowBadge="{Binding HasUnreadMessages}"
                                                       BadgeText="{Binding UnreadCount}"
                                                       BadgeColor="Red"
                                                       BadgeTextColor="White">
                                        <controls:BadgeView.Content>
                                            <Border WidthRequest="50"
                                                   HeightRequest="50"
                                                   BackgroundColor="{AppThemeBinding Light={DynamicResource PrimaryColorLight}, Dark={DynamicResource PrimaryColorDark}}">
                                                <Border.StrokeShape>
                                                    <Ellipse />
                                                </Border.StrokeShape>
                                                <Label Text="{Binding SenderInitials}"
                                                      TextColor="White"
                                                      FontFamily="Roboto-Medium"
                                                      FontSize="18"
                                                      HorizontalOptions="Center"
                                                      VerticalOptions="Center" />
                                            </Border>
                                        </controls:BadgeView.Content>
                                    </controls:BadgeView>

                                    <!-- Message Info -->
                                    <StackLayout Grid.Column="1" 
                                                Spacing="4" 
                                                Margin="12,0"
                                                VerticalOptions="Center">
                                        <!-- Sender Name and Time -->
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>

                                            <Label Grid.Column="0"
                                                  Text="{Binding SenderName}"
                                                  FontSize="16"
                                                  FontFamily="Roboto-Medium"
                                                  TextColor="{AppThemeBinding Light={DynamicResource PrimaryTextColorLight}, Dark={DynamicResource PrimaryTextColorDark}}" />

                                            <Label Grid.Column="1"
                                                  Text="{Binding Time}"
                                                  FontSize="12"
                                                  FontFamily="Roboto-Regular"
                                                  TextColor="{AppThemeBinding Light={DynamicResource SecondaryTextColorLight}, Dark={DynamicResource SecondaryTextColorDark}}" />
                                        </Grid>

                                        <!-- Message Preview -->
                                        <Label Text="{Binding Message}"
                                              FontSize="14"
                                              FontFamily="Roboto-Regular"
                                              TextColor="{AppThemeBinding Light={DynamicResource SecondaryTextColorLight}, Dark={DynamicResource SecondaryTextColorDark}}"
                                              MaxLines="2"
                                              LineBreakMode="TailTruncation" />
                                    </StackLayout>

                                    <!-- Status Indicator -->
                                    <StackLayout Grid.Column="2" 
                                                VerticalOptions="Center"
                                                Spacing="4">
                                        <!-- Online Status -->
                                        <Ellipse WidthRequest="12"
                                                HeightRequest="12"
                                                Fill="{Binding IsOnline, Converter={StaticResource BoolToColorConverter}}"
                                                HorizontalOptions="Center" />

                                        <!-- Message Type Icon -->
                                        <Label Text="{Binding MessageTypeIcon}"
                                              FontSize="16"
                                              HorizontalOptions="Center"
                                              TextColor="{AppThemeBinding Light={DynamicResource SecondaryTextColorLight}, Dark={DynamicResource SecondaryTextColorDark}}" />
                                    </StackLayout>
                                </Grid>
                            </Border>
                        </SwipeView>
                    </DataTemplate>
                </CollectionView.ItemTemplate>

                <!-- Empty View -->
                <CollectionView.EmptyView>
                    <StackLayout HorizontalOptions="Center" 
                                VerticalOptions="Center"
                                Spacing="16">
                        <Label Text="ðŸ’¬"
                              FontSize="48"
                              HorizontalOptions="Center" />
                        <Label Text="No messages yet"
                              FontSize="18"
                              FontFamily="Roboto-Medium"
                              HorizontalOptions="Center"
                              TextColor="{AppThemeBinding Light={DynamicResource SecondaryTextColorLight}, Dark={DynamicResource SecondaryTextColorDark}}" />
                        <Label Text="Start a conversation"
                              FontSize="14"
                              FontFamily="Roboto-Regular"
                              HorizontalOptions="Center"
                              TextColor="{AppThemeBinding Light={DynamicResource SecondaryTextColorLight}, Dark={DynamicResource SecondaryTextColorDark}}" />
                    </StackLayout>
                </CollectionView.EmptyView>
            </CollectionView>
        </Grid>
    </ContentPage.Content>
</ContentPage>